<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Basic CSV handing.</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" href="common_styles.css">
	<link rel="icon" type="image/png" href="images/cafchem_favicon.png" sizes="16x16" />
	<style>	
		
		
			

		

		#main_flex {
			display: flex;
			flex-direction: row;
			width: 100%;}

		#flex_div1 {
			width: 50%;
			text-align: left;
			display: flex;
			flex-direction: column;}

		#flex_div2 {
			width: 50%;
			text-align: left;
			display: flex;
			flex-direction: column;}

		#plot_holder{
			margin: auto;}


		#plot {
			background-color: white;
			margin: auto;}
			

		
		button {text-align: center;
			width: 200px;}

	</style>
</head>

<body>
	<div id="main_title"> <img  style="padding: 2% 1% 1% 5%;" src="images/comp_chem_2_small.jpg" alt="Computer"> 
		<h1 style="padding: 50px;">Read in a CSV file and visualize data.</h1>
	</div>
	
	<div id="menu_holder">
		<a class="menu_box" href="Chem_webapps_frontpage.html" style="color: #00008B;">Back to Chemistry Web Apps</a>
	</div>
	<br>

	<div id="intro">
		<ul>
			<li>Each row should be delimited by commas.</li>
			<li>Longer column titles may be truncated.</li>
			<li>To plot data:
				<ol>
					<li>Select a file to read and the press the read data button.</li>
					<li>Columns from your CSV file will then populate the selection menus
					for the <em>x</em> and <em>y</em> data. Choose which series you want to plot.</li>
					<li>Press the "set properties and plot" button.</li>
					<li>You can change your choices at any time by repeating steps 2 and 3.</li>  
				</ol>
			</li>
		</ul>
	</div>
	<hr>
	<section id = "main_flex">
		<div id = "flex_div1">
			<div style="margin: auto;">
				<label for="choose_file"> Select a CSV file to process.</label>
				<input type="file" id="choose_file" accept=".csv">
			</div>
			<div style="margin: auto;">
			<button id="read_csv_b" onclick="read_csv()">Read data from CSV</button>
			</div>
			<div><hr></div>
			<div id="options_holder" style="margin: auto;">
				<label for="x_options">Choose a property for the x-axis:</label>
				<select id="x_options" name="x_options"></select>
				<br>	
				<label for="y_options">Choose a property for the y-axis:</label>
				<select id="y_options" name="y_options"></select>
			</div>
			<div><hr></div>
			<div id="buttons_holder" style="margin: auto;">
				<button id="display_molecule_b" onclick="regress()">
				Set properties and plot.</button> 
			</div>
		</div>
		<div id = "flex_div2">
			<span id = "result_of_calc"></span>
			<div id="plot_holder"> </div>
		</div>
	</section>
	<div id="table_section"></div>
	<p>This is the work of Dr. Mauricio Cafiero and may be used widely though attribution is appreciated.</p>

</body>

<script>

// define global variables ================================================================================================

var number_columns, number_points; 
var column_titles = new Array;
var smiles_array = new Array;
var x_prop_name = new String();
var y_prop_name = new String();
var max_columns = 10;
var chartInstance; // Chart.js instance


function read_csv(){

//gets file name from input and tries to open it. Throws an error if it cannot be opened ==================================

	var file_holder = document.getElementById("choose_file");
	var reader = new FileReader();

	var [file] = file_holder.files;

	if (file){
		console.log("type:",file.type)
		reader.readAsText(file);

		reader.addEventListener("load", event => {console.log("File read!");
			var content = reader.result;
			parse_csv(content);});

		reader.addEventListener("error", event => {console.log("Error reading file!");});
	} else {
		alert("please select a file");}
}

function parse_csv(file_content){
	
//accepts a file and parses it as a CSV: splits it into rows, the takes the top row at column titles ======================
// reads into a 2-D array called dataframe and a separate array for column titles

	var rows = file_content.split(/\r?\n/);

	number_points = rows.length - 1;
	column_titles = rows[0].split(",");
	number_columns = column_titles.length

	while (rows[number_points] == ""){
		rows.length = number_points - 1;
		number_points = rows.length - 1;
		console.log("deleting blank line at end of CSV!");}

	var dataframe = new Array(number_points);
	for (i=0; i < number_points; i++){
		dataframe[i] = Array.from(rows[i+1].split(","));}

//creates as many columns as needed in the "table section" and displays the data in each column ===========================

	var output_div2 = document.getElementById("table_section");
	var grid_columns = new String("")
	var grid_areas = new String("")
	var col_html = new String("")
	var col_width = Math.floor(100/number_columns);

	for (i=0; i < number_columns; i++){
		grid_columns += col_width+"% ";
		grid_areas += "col"+i;
		if (number_columns > max_columns){
			col_html += "<div style='display: none; overflow: hidden; text-wrap: nowrap; outline: solid white; margin: 0% 2% 0% 2%;' id='col"+i+"'><\/div> ";}
		else{
		col_html += "<div style='overflow: hidden; text-wrap: nowrap; outline: solid white; margin: 0% 2% 0% 2%;' id='col"+i+"'><\/div> ";}}

	output_div2.style.display = "grid";
	output_div2.style.gridTemplateColumns = grid_columns;
	output_div2.style.gridTemplateRows = "auto";
	output_div2.style.gridTemplateAreas = grid_areas;
	
	output_div2.innerHTML = col_html;

	for (i=0; i < number_columns; i++){
		var col_name = "col"+i;
		col = document.getElementById(col_name);
		col.innerHTML = column_titles[i]+"<hr style='margin: 0;'>";
		for (j = 0; j < number_points; j++){
			if (column_titles[i] == "SMILES"){
				smiles_array[j] = dataframe[j][i];}
			var row_text = "<br>"+dataframe[j][i];
			col.insertAdjacentHTML("beforeend",row_text);};}

	var alt_text = new String(`<hr><div>Your CSV has more than ${max_columns} columns, so the data will not be displayed. Columns are: `);
	if (number_columns > max_columns){
		for (i = 0; i < number_columns; i++){
			alt_text += ` ${column_titles[i]}`;}
		 alt_text += `. <div><br><hr>`;
		output_div2.insertAdjacentHTML("beforeBegin",alt_text);}

//here sets up the property selector with column titles ===================================================================

	var x_div = document.getElementById("x_options");
	var y_div = document.getElementById("y_options");
	x_div.innerHTML = "";
	y_div.innerHTML = "";

	var prop_html = new String("")
	
	for (j = 0; j < number_columns; j++){
		prop_html += "<option id='prop_opt"+j+"' value='"+column_titles[j]+"'>"+column_titles[j]+"<\/option> ";}

	x_div.insertAdjacentHTML("beforeend",prop_html);
	y_div.insertAdjacentHTML("beforeend",prop_html);
}


function regress() {

//Below: get all of the x and y values for name and put in arrays. throws an error if datapoints are NaN. =================  

	var x_div = document.getElementById("x_options");
	var y_div = document.getElementById("y_options");

	if (x_options.innerHTML == ""){
		alert("No options set!");}

	var x_ind = x_div.selectedIndex;
	var x_prop = x_div.options[x_ind].value;
	x_prop_name = x_prop;

	var y_ind = y_div.selectedIndex;
	var y_prop = y_div.options[y_ind].value;
	y_prop_name = y_prop;
	
	var x_col_name = "col"+x_ind;
	var x_col_to_use = document.getElementById(x_col_name);

	var y_col_name = "col"+y_ind;
	var y_col_to_use = document.getElementById(y_col_name);

	var x_content = x_col_to_use.innerHTML;
	var y_content = y_col_to_use.innerHTML;

	var x_arr = x_content.split("<br>");
	var y_arr = y_content.split("<br>");

	x_arr.shift();
	y_arr.shift();
	x_arr.forEach(function(value,i) {x_arr[i] = Number(value);});
	y_arr.forEach(function(value,i) {y_arr[i] = Number(value);});

	if (x_arr.length == y_arr.length){
		no_points = x_arr.length;}
	else{
		alert("array dimension mismatch!");}

//Calculate values for regression and R^2. Format output and write to result of calc element ==============================

	var sum_x=0.0, sum_y=0.0, sum_x2=0.0, sum_xy=0.0, ave_y=0.0, SSR=0.0, SST=0.0

	x_arr.forEach(value => {sum_x += value;});
	y_arr.forEach(value => {sum_y += value;});
	ave_y = sum_y/no_points;
	x_arr.forEach(value => {sum_x2 += value*value;});
	x_arr.forEach(function(value,index) {sum_xy += value*y_arr[index]});	
	
	var m = (no_points*sum_xy - sum_x*sum_y)/(no_points*sum_x2 - Math.pow(sum_x,2));
	var b = (sum_y - m*sum_x)/no_points;
	y_calc = x_arr.map(x => m*x+b);

	y_arr.forEach(function(value,index) {SSR += Math.pow((value-y_calc[index]),2)});
	y_arr.forEach(value => {SST += Math.pow((value-ave_y),2)});
	let R2 = 1-(SSR/SST);	
	m = Math.round(100*m)/100;
	b = Math.round(100*b)/100;
	R2 = Math.round(100*R2)/100;

	document.getElementById("result_of_calc").innerHTML =
    	"The best-fit line is: <strong> y=" + m + " x +"+b+"</strong> \
and the R<sup>2</sup> is "+R2+".";

//Create Chart.js scatter plot with regression line ======================================================================

	// Clear any existing chart
	if (chartInstance) {
		chartInstance.destroy();
	}
	
	// Create canvas element
	document.getElementById("plot_holder").innerHTML = '<canvas id="chart_canvas" width="400" height="400"></canvas>';
	
	const ctx = document.getElementById('chart_canvas').getContext('2d');
	
	// Prepare data for Chart.js
	const scatterData = x_arr.map((value, index) => ({x: value, y: y_arr[index]}));
	const lineData = x_arr.map((value, index) => ({x: value, y: y_calc[index]}));
	
	chartInstance = new Chart(ctx, {
		type: 'scatter',
		data: {
			datasets: [
				{
					label: 'Data Points',
					data: scatterData,
					backgroundColor: '#DC143C',
					borderColor: '#DC143C',
					pointRadius: 6,
					pointHoverRadius: 8,
					showLine: false
				},
				{
					label: 'Regression Line',
					data: lineData,
					backgroundColor: '#00008B',
					borderColor: '#00008B',
					pointRadius: 0,
					pointHoverRadius: 0,
					showLine: true,
					tension: 0
				}
			]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				title: {
					display: true,
					text: 'Linear Regression Analysis'
				},
				legend: {
					display: true,
					position: 'top'
				}
			},
			scales: {
				x: {
					title: {
						display: true,
						text: x_prop_name
					},
					grid: {
						color: 'rgba(0,0,0,0.1)'
					}
				},
				y: {
					title: {
						display: true,
						text: y_prop_name
					},
					grid: {
						color: 'rgba(0,0,0,0.1)'
					}
				}
			},
			interaction: {
				intersect: false,
				mode: 'index'
			}
		}
	});

// Add a div explaining the plot ==========================================================================================

	if (!document.getElementById("plot_explainer")) {
		var new_div = document.createElement("div");
		new_div.setAttribute("name", "plot_explainer");
		new_div.setAttribute("id", "plot_explainer");
		new_div.innerHTML = "The red points are the raw data and the blue line is "
		+"the best fit line. The limits of the <em>x</em> and <em>y</em> axes are "
		+"indicated.";
		document.getElementById("flex_div2").appendChild(new_div);}
}	
</script>

</html>
